# Cline Rules for Crew Revolutionary Features

## üöÄ SIMPLE DEPLOYMENT WORKFLOW (For Developer)

### **Local Testing:**
```bash
./deploy-dev.sh
```
- Test changes locally at http://localhost:5173
- NO version bump, NO git push

### **Deploy to Production:**
```bash
./deploy-prod.sh patch "what changed"
```
- Bumps ALL versions (React + Backend + Flutter)
- Commits & pushes to git
- DigitalOcean auto-deploys

### **Deploy Flutter to TestFlight:**
```bash
# 1. First sync versions
./deploy-prod.sh patch "what changed"

# 2. Then build Flutter IPA
cd mobile && flutter clean && flutter build ipa --release

# 3. IPA location: mobile/build/ios/ipa/mobile.ipa
# 4. Upload via Transporter app or Xcode Organizer
```

**That's it! Read `DEPLOYMENT-WORKFLOW.md` for details.**

---

## Development Environment
- **Local Development**: Mac environment
- **Local Testing**: `./deploy-dev.sh` for development deployment and testing
- **Production Deploy**: `./deploy-prod.sh` pushes to git main ‚Üí DigitalOcean App Platform auto-pulls and rebuilds
- **Version Management**: ALL platforms sync automatically (React, Backend, Flutter)

## Project Context
Slack-like chat application with **REVOLUTIONARY** multi-assignee tasks, teams system, and full Calendar/Timeline integration + **CRITICAL PRIORITY: Google Calendar & Tasks Sync Implementation**.

## üìã WORKFLOW INSTRUCTIONS

### **Start Each Session By Reading These Files:**
1. `.clinerules` - Current project context and deployment status
2. `SYNCUP-MIGRATION-PLAN.md` - Technical architecture and implementation plan
3. `SYNCUP-TODO.md` - Detailed accomplishments and next priorities
4. `SYNCUP_GOOGLE_CALENDAR_AND_TASKS_SYNC_STRATEGY.md` - Expert-reviewed Google sync strategy
5. `SYNCUP-FLUTTER-DEVELOPMENT-PLAN.md` - Flutter mobile app development roadmap and phase tracking

### **Update These Files After Making Changes:**
- `SYNCUP-TODO.md` - Add new accomplishments and update status
- `SYNCUP-MIGRATION-PLAN.md` - Update technical progress and component status
- `SYNCUP-FLUTTER-DEVELOPMENT-PLAN.md` - Update Flutter/React features, phase progress, and mobile development status
- `.clinerules` - Update deployment status and current features

### **Before Closing Each Session, Update These Files:**
1. `SYNCUP-TODO.md` - Document what was accomplished with technical details
2. `SYNCUP-MIGRATION-PLAN.md` - Update implementation status and next milestones
3. `SYNCUP-FLUTTER-DEVELOPMENT-PLAN.md` - Update Flutter phase completions and React app feature parity
4. `.clinerules` - Update current deployment status and testing checklist

### **Always List in Chat:**
- **Accomplishments**: Technical specifics of what was built/deployed
- **Next Steps**: Concrete priorities for the next session with file locations
- **Testing Status**: What needs to be validated in development first, then production
- **Deployment Info**: Current dev status and readiness for user production deploy

### **üìù DOCUMENTATION STANDARDS:**
**Create lean, execution-focused markdown files:**
- ‚úÖ **Include ALL technical details** needed for developer execution
- ‚úÖ **Complete code examples, schemas, dependencies, commands**
- ‚úÖ **Precise timelines, effort estimates, success metrics**
- ‚ùå **NO excessive explanations or marketing language**
- ‚ùå **NO repetitive clarifications for humans**
- ‚ùå **NO verbose reasoning - just actionable facts**
- **Goal**: Developer can execute from documentation alone without additional context

## üöÄ DEVELOPMENT & DEPLOYMENT WORKFLOW
1. **Development**: Use `./deploy-dev.sh patch "description"` for local testing
2. **Production Deploy**: User deploys to production after successful dev testing
3. **Auto-Deploy**: DigitalOcean App Platform automatically rebuilds on production deploy
4. **Database Schema**: REVERTED TO MIGRATIONS - Complete schema had critical bugs and syntax errors
5. **Database**: PostgreSQL cluster on DigitalOcean with migration system in `backend/migrations/`
6. **Testing**: Always test in development first, then user deploys to production

### **‚ö° FAST-TRACK DEPLOYMENT (Minor Patches Only):**
**SAFE to skip deploy-dev.sh for:**
- ‚úÖ CSS/styling fixes (colors, spacing, fonts)
- ‚úÖ Text/copy changes (labels, messages, tooltips)  
- ‚úÖ Minor UI tweaks (button positions, icons)
- ‚úÖ Frontend-only configuration changes
- ‚úÖ Documentation updates
- ‚úÖ Version bumps without logic changes

**‚ö†Ô∏è NEVER skip deploy-dev.sh for:**
- ‚ùå Database migrations or schema changes
- ‚ùå API endpoint modifications
- ‚ùå Authentication/security changes
- ‚ùå Backend logic changes
- ‚ùå New features or components
- ‚ùå Environment variable changes
- ‚ùå Dependency updates

### **Current Deployment Status (Nov 22, 2025 - PRODUCTION-GRADE MESSAGING!):**
- ‚úÖ **MESSAGING ARCHITECTURE**: Industry-standard iMessage-style reliability implemented
- ‚úÖ **Socket.IO ROLE**: Now notification-only layer (not message delivery)
- ‚úÖ **HTTP API DELIVERY**: Database-first approach for 100% reliable messaging
- ‚úÖ **TYPING INDICATORS**: Robust parsing handles React ‚Üî iOS communication
- ‚úÖ **FIREBASE TOKEN CACHING**: Efficient token reuse prevents race conditions
- ‚úÖ **BUILD FIXED**: All build issues resolved (BarChart3Icon, Node.js, CSS)
- ‚úÖ **CSS LOADING**: Tailwind PostCSS configuration fixed - 84.76kB CSS generation
- ‚úÖ **PORT BINDING**: Fixed 0.0.0.0 host binding for DigitalOcean health checks
- ‚úÖ **SERVER STARTUP**: Non-fatal database connection test - server stays running
- ‚úÖ **DEPENDENCY FIX**: Added complete Express dependency chain (function-bind, side-channel, etc.)
- ‚úÖ **WORKSPACE FIX**: Copied package-lock.json to backend for DigitalOcean isolation build
- ‚úÖ **NODE.JS MODERNIZED**: Upgraded to Node.js 24+ for better performance and security
- ‚úÖ **KNOWLEDGE SYSTEM EMERGENCY FIX**: Migration dependency issues resolved with CASCADE
- ‚úÖ **Backend Version**: v1.8.47 - Production stable with reliable messaging
- ‚ùå **COMPLETE SCHEMA FAILED**: Reverted due to PostgreSQL syntax errors, view conflicts, and trigger bugs
- ‚úÖ **MIGRATIONS RESTORED**: Back to reliable migration system in `backend/migrations/run-migrations.js`
- ‚úÖ **UUID FUNCTIONS**: Fixed mark_task_complete_individual() and mark_task_incomplete_individual() 
- ‚úÖ **PRODUCTION STABLE**: Emergency fix resolved "cannot drop table knowledge_items" deployment failure
- üéâ **TESTFLIGHT DEPLOYED**: Flutter iOS app successfully deployed to TestFlight for beta testing!
- üì± **FLUTTER APP VERSION**: v1.1.0+2 (build 2) - Live on TestFlight beta platform
- üì± **FLUTTER APP STATUS**: 75% complete - Core messaging done, iOS deployment successful
- üéØ **NEXT PRIORITIES**: Complete Phase 3 polish (2%), beta testing, then revolutionary features
- üìã **MIGRATIONS BACK**: All future database changes use individual migration files

## üéâ REVOLUTIONARY FEATURES DEPLOYED
### **üéØ Multi-Assignee Tasks with Individual Progress Tracking:**
- Tasks assigned to multiple people simultaneously
- **Collaborative Mode**: Any assignee can mark done/edit/reassign
- **Individual Response Mode**: Each assignee must mark done separately with "2/7 done" progress
- Smart permissions and edit rights for all assignees

### **üë• Team/Group System with @mention Support:**
- Create teams: "kitchen-team", "frontend-dev", "marketing", etc.
- @mention teams in chat, assign tasks to entire teams
- Combined assignments: individuals + teams on same task
- Professional color coding with 12 distinct team colors

### **üìÖ Production Calendar & Timeline Integration:**
- **Real ChannelCalendar.jsx**: Monthly view connected to production API
- **Real ChannelTimeline.jsx**: Full Gantt chart with dependencies
- **Seamless View Switching**: Chat/Calendar/Timeline buttons in headers
- **Multi-Channel Support**: View multiple channels simultaneously

### **üîÑ GOOGLE SYNC SYSTEM (IN DEVELOPMENT - CRITICAL PRIORITY):**
- **Expert Developer Fixes Applied**: End-exclusive dates, no email spam, timezone handling
- **Smart Strategy Algorithm**: Auto-determines Calendar vs Tasks vs Both based on task attributes
- **De-duplication System**: sourceKey prevents duplicate events/tasks
- **Incremental Sync**: Calendar uses syncToken, Tasks uses updatedMin for efficiency
- **Per-Workspace Calendars**: Secondary calendars to avoid primary calendar spam
- **Field-Level Conflict Resolution**: Title/notes overwritable, completion status protected

## Architecture Decisions
- **Channel-Based Projects**: Each channel IS a project (simple, scalable)
- **Multi-Assignee Innovation**: Two modes for task completion tracking
- **Team-Based Collaboration**: Groups can be assigned and @mentioned
- **Professional Design**: Modern color system with channel color coding
- **Zero Learning Curve**: Familiar chat interface with powerful new views
- **Google Sync Integration**: Intelligent sync to Calendar (time-blocking) and Tasks (completion tracking)

## Database Schema (Current + Planned)
### **Current (Live):**
- ‚úÖ `channel_tasks` table: Enhanced with multi-assignee support
- ‚úÖ `workspace_teams` table: Team/group definitions
- ‚úÖ `workspace_team_members` table: Team membership relationships
- ‚úÖ **Views**: `channel_tasks_with_progress`, `user_task_assignments`
- ‚úÖ **Functions**: `is_task_assignee()`, `get_task_completion_progress()`, `mark_task_complete_individual()`

### **Planned (Migration 023 - IMMEDIATE):**
- üîÑ `channel_tasks` enhanced: google_task_id, google_calendar_event_id, sync_strategy, timezone
- üîÑ `workspace_google_sync_config` table: Per-workspace sync configuration
- üîÑ `user_google_sync_preferences` table: User OAuth tokens and preferences
- üîÑ `google_sync_operations` table: Operation logging and debugging

## Key API Endpoints
### **Current (Multi-Assignee):**
- `GET /api/workspaces/:id/threads/:id/tasks` - Enhanced with multi-assignee data
- `POST /api/workspaces/:id/threads/:id/tasks` - Create with assignees/teams
- `POST /api/workspaces/:id/threads/:id/tasks/:id/complete` - Individual completion
- `GET /api/workspaces/:id/threads/:id/tasks/:id/progress` - Progress tracking
- `GET /api/workspaces/:id/teams` - Team management
- `POST /api/workspaces/:id/teams` - Create teams

### **Planned (Google Sync - IMMEDIATE PRIORITY):**
- `POST /api/workspaces/:ws/threads/:th/tasks/:taskId/sync/google` - Manual sync trigger
- `GET /api/workspaces/:ws/sync/google/status` - Sync health monitoring
- `GET /api/auth/google/authorize` - OAuth authorization flow
- `GET /api/auth/google/callback` - OAuth callback handling

## Testing Checklist (Production)
### **Current Revolutionary Features:**
1. ‚úÖ **View Switching**: Click Chat/Calendar/Timeline buttons in channel headers
2. üîÑ **Calendar View**: See real tasks from API in monthly calendar format
3. üîÑ **Timeline View**: Gantt chart with task dependencies and progress bars
4. üîÑ **Multi-Assignee**: Look for "2/7 done" style progress indicators
5. üîÑ **Team Assignment**: Create teams and assign to tasks
6. üîÑ **Individual Completion**: Each assignee marks done separately
7. üîÑ **@Team Mentions**: Type @team-name in chat (future iteration)

### **Google Sync Testing (NEXT PHASE):**
8. üîÑ **Google OAuth**: Authorize Google Calendar + Tasks access
9. üîÑ **Smart Strategy**: Verify tasks sync to appropriate Google service
10. üîÑ **No Email Spam**: Confirm no unintended email notifications
11. üîÑ **De-duplication**: Prevent duplicate events using sourceKey
12. üîÑ **Timezone Handling**: Proper timezone conversion in events
13. üîÑ **Conflict Resolution**: Handle simultaneous edits gracefully

## File Locations (Production Ready + Planned)
### **Current:**
- **Database Schema**: `backend/migrations/` (BACK TO MIGRATION SYSTEM)
- **Database Setup**: `backend/setup-database.js` (uses migrations via run-migrations.js)
- **Migration Runner**: `backend/migrations/run-migrations.js` (core database setup)
- **Calendar**: `frontend/src/components/calendar/ChannelCalendar.jsx`
- **Timeline**: `frontend/src/components/timeline/ChannelTimeline.jsx` 
- **Multi-Channel**: `frontend/src/components/calendar/ChannelDropdown.jsx`
- **API**: `backend/routes/channel-tasks.js` (enhanced with multi-assignee)
- **Design System**: `frontend/tailwind.config.js` (professional color palette)

### **Google Sync Implementation (IMMEDIATE PRIORITY):**
- **Schema Enhancement**: Create new migration files in `backend/migrations/`
- **Core Logic**: `backend/sync/mappers.js` (strategy algorithm + data mapping)
- **Calendar Provider**: `backend/sync/google/CalendarProvider.js`
- **Tasks Provider**: `backend/sync/google/TasksProvider.js`
- **Main Service**: `backend/sync/SyncService.js`
- **Backoff Utility**: `backend/utils/backoff.js`
- **Routes**: `backend/routes/googleSync.js`, `backend/routes/googleAuth.js`
- **Frontend**: `frontend/src/components/sync/GoogleSyncButton.jsx`

## Deployment Process
1. **Develop Locally**: Make changes and test using `backend/setup-database.js` (runs migrations)
2. **Git Commit**: `git add . && git commit -m "description"`
3. **Deploy to Dev**: `./deploy-dev.sh patch "work completed description"`
4. **Test in Dev**: Validate features in development environment
5. **User Deploys to Production**: After successful dev testing, user will deploy to production
6. **Auto-Build**: DigitalOcean rebuilds app automatically on production deploy
7. **Migration Execution**: Migrations in `backend/migrations/` execute on startup

## Emergency Procedures
- **Rollback**: `git revert HEAD && git push origin main`
- **Check Logs**: DigitalOcean App Platform ‚Üí Runtime Logs
- **Database Access**: Use provided DigitalOcean database credentials
- **Migration Issues**: Check individual migration files in `backend/migrations/` for any syntax errors

## üöÄ NEXT SESSION DEVELOPMENT OPTIONS (Nov 13, 2025)

### **üéØ FLUTTER MOBILE DEVELOPMENT - PHASE 2 COMPLETE ‚úÖ**
**Status**: Phase 2 Complete ‚úÖ - Flutter app connected to production backend successfully!

#### **‚úÖ FLUTTER BACKEND INTEGRATION COMPLETE (Nov 14, 2025):**
1. ‚úÖ **Production API Connection**: Flutter app talks directly to `https://coral-app-rgki8.ondigitalocean.app`
2. ‚úÖ **Environment Auto-Detection**: Debug (localhost) ‚Üî Release (production) switching
3. ‚úÖ **Real WorkspaceService**: Complete API integration with production workspace system
4. ‚úÖ **Data Models Built**: Flutter models matching PostgreSQL schema perfectly
5. ‚úÖ **Dio HTTP Client**: Professional HTTP client with Firebase auth token support
6. ‚úÖ **Beautiful UI Preserved**: Gorgeous Flutter interface maintained during integration
7. ‚úÖ **Error Handling**: Graceful fallbacks to demo data when backend unavailable
8. ‚úÖ **iOS Deployment Ready**: iPhone "Maximus" registered with Apple Developer account

#### **üì± NEXT SESSION OPTIONS (Choose Your Adventure!):**

**üéØ OPTION A: iPhone Deployment (1 Week - RECOMMENDED)**
- Update Xcode iOS SDK for iPhone Maximus compatibility
- Deploy Flutter app to real iPhone hardware
- Test revolutionary features on actual device
- Validate mobile UX and performance

**üéØ OPTION B: Firebase Authentication (1-2 Weeks)**
- Google sign-in integration matching web app
- Real user workspace loading instead of demo data
- Complete Flutter ‚Üî Backend authentication flow
- Foundation for real-time messaging

**üéØ OPTION C: Real-Time Messaging (6 Weeks - Major Phase)**
- Socket.IO Flutter integration for live chat
- Mobile message composer with @mentions, attachments
- Typing indicators and real-time presence
- Push notifications with Firebase Cloud Messaging

**üéØ OPTION D: Hybrid Approach (BALANCED)**
- Week 1: iPhone deployment and hardware testing
- Week 2: Firebase authentication integration
- Weeks 3-8: Real-time messaging system development

#### **Flutter Timeline**: Phase 2 Complete ‚úÖ ‚Üí Next: Choose Option A-D ‚Üí 6-12 weeks to production

---

### **üéØ OPTION B: GOOGLE CALENDAR & TASKS SYNC (ORIGINAL PRIORITY)**
**Status**: Expert strategy completed, ready for implementation

#### **Google Sync Phase 1: Database & Core Infrastructure**
1. **Create Google Sync Migration**: New migration file `backend/migrations/029_google_sync_final.sql`
2. **Install Dependencies**: `npm install googleapis@^128.0.0 node-cache@^5.1.2`
3. **Create Mappers**: `backend/sync/mappers.js` with expert fixes (end-exclusive dates, timezone handling)

#### **Google Sync Phase 2: Google API Providers**  
4. **Calendar Provider**: `backend/sync/google/CalendarProvider.js` with syncToken support
5. **Tasks Provider**: `backend/sync/google/TasksProvider.js` with updatedMin polling
6. **Backoff Utility**: `backend/utils/backoff.js` for API rate limiting

#### **Google Sync Phase 3: Service Layer**
7. **Sync Service**: `backend/sync/SyncService.js` main orchestration
8. **Routes**: `backend/routes/googleSync.js` and `backend/routes/googleAuth.js`
9. **Frontend Integration**: Google sync buttons and status displays

#### **Google Sync Timeline**: 4-6 weeks to production Google sync system

---

### **üéØ OPTION C: HYBRID APPROACH (BALANCED)**
**Alternate between Flutter development and Google sync implementation**

#### **Week 1**: Flutter Authentication & Firebase setup
#### **Week 2**: Google sync database migration and core mappers
#### **Week 3**: Flutter real-time messaging and mobile UI
#### **Week 4**: Google sync API providers and service layer
#### **Continue alternating**: Build both systems in parallel

---

**üö® CURRENT DEPLOYMENT STATUS (Updated Nov 13, 2025):**
- ‚úÖ **FLUTTER APP RUNNING**: Phase 1 complete at http://localhost:8081
- ‚úÖ **STRIPE SYSTEM COMPLETE**: Full subscription system with admin controls deployed
- ‚úÖ **REVOLUTIONARY FEATURES LIVE**: Multi-assignee tasks, teams, calendar/timeline in production
- ‚úÖ **BACKEND INFRASTRUCTURE**: All APIs ready for both Flutter and Google sync development
- üéØ **READY FOR NEXT PHASE**: Two excellent development paths available

**üéØ RECOMMENDATION**: Continue with Flutter Phase 2 for mobile app momentum, then add Google sync in Phase 4
