# Cline Rules for Crew Revolutionary Features

## Project Context
Slack-like chat application with **REVOLUTIONARY** multi-assignee tasks, teams system, and full Calendar/Timeline integration + **CRITICAL PRIORITY: Google Calendar & Tasks Sync Implementation**.

## ðŸ“‹ WORKFLOW INSTRUCTIONS

### **Start Each Session By Reading These Files:**
1. `.clinerules` - Current project context and deployment status
2. `SYNCUP-MIGRATION-PLAN.md` - Technical architecture and implementation plan
3. `SYNCUP-TODO.md` - Detailed accomplishments and next priorities
4. `SYNCUP_GOOGLE_CALENDAR_AND_TASKS_SYNC_STRATEGY.md` - **NEW** Expert-reviewed Google sync strategy

### **Update These Files After Making Changes:**
- `SYNCUP-TODO.md` - Add new accomplishments and update status
- `SYNCUP-MIGRATION-PLAN.md` - Update technical progress and component status
- `.clinerules` - Update deployment status and current features

### **Before Closing Each Session, Update These Files:**
1. `SYNCUP-TODO.md` - Document what was accomplished with technical details
2. `SYNCUP-MIGRATION-PLAN.md` - Update implementation status and next milestones  
3. `.clinerules` - Update current deployment status and testing checklist

### **Always List in Chat:**
- **Accomplishments**: Technical specifics of what was built/deployed
- **Next Steps**: Concrete priorities for the next session with file locations
- **Testing Status**: What needs to be validated in development first, then production
- **Deployment Info**: Current dev status and readiness for user production deploy

## ðŸš€ DEVELOPMENT & DEPLOYMENT WORKFLOW
1. **Development**: Use `./deploy-dev.sh patch "description"` for local testing
2. **Production Deploy**: User deploys to production after successful dev testing
3. **Auto-Deploy**: DigitalOcean App Platform automatically rebuilds on production deploy
4. **Database Schema**: REVERTED TO MIGRATIONS - Complete schema had critical bugs and syntax errors
5. **Database**: PostgreSQL cluster on DigitalOcean with migration system in `backend/migrations/`
6. **Testing**: Always test in development first, then user deploys to production

### **Current Deployment Status (Nov 12, 2025 - EMERGENCY KNOWLEDGE SYSTEM FIX):**
- âœ… **BUILD FIXED**: All build issues resolved (BarChart3Icon, Node.js, CSS)
- âœ… **CSS LOADING**: Tailwind PostCSS configuration fixed - 84.76kB CSS generation
- âœ… **PORT BINDING**: Fixed 0.0.0.0 host binding for DigitalOcean health checks
- âœ… **SERVER STARTUP**: Non-fatal database connection test - server stays running
- âœ… **DEPENDENCY FIX**: Added complete Express dependency chain (function-bind, side-channel, etc.)
- âœ… **WORKSPACE FIX**: Copied package-lock.json to backend for DigitalOcean isolation build
- âœ… **NODE.JS MODERNIZED**: Upgraded to Node.js 24+ for better performance and security
- âœ… **KNOWLEDGE SYSTEM EMERGENCY FIX**: Migration dependency issues resolved with CASCADE
- âœ… **Latest Deploy**: Commit ce51d3a - v1.8.16 with Knowledge System CASCADE fix deployed
- âŒ **COMPLETE SCHEMA FAILED**: Reverted due to PostgreSQL syntax errors, view conflicts, and trigger bugs
- âœ… **MIGRATIONS RESTORED**: Back to reliable migration system in `backend/migrations/run-migrations.js`
- âœ… **UUID FUNCTIONS**: Fixed mark_task_complete_individual() and mark_task_incomplete_individual() 
- âœ… **PRODUCTION STABLE**: Emergency fix resolved "cannot drop table knowledge_items" deployment failure
- ðŸŽ¯ **CRITICAL PRIORITY**: Google Calendar & Tasks sync implementation with expert fixes
- ðŸ“‹ **MIGRATIONS BACK**: All future database changes use individual migration files

## ðŸŽ‰ REVOLUTIONARY FEATURES DEPLOYED
### **ðŸŽ¯ Multi-Assignee Tasks with Individual Progress Tracking:**
- Tasks assigned to multiple people simultaneously
- **Collaborative Mode**: Any assignee can mark done/edit/reassign
- **Individual Response Mode**: Each assignee must mark done separately with "2/7 done" progress
- Smart permissions and edit rights for all assignees

### **ðŸ‘¥ Team/Group System with @mention Support:**
- Create teams: "kitchen-team", "frontend-dev", "marketing", etc.
- @mention teams in chat, assign tasks to entire teams
- Combined assignments: individuals + teams on same task
- Professional color coding with 12 distinct team colors

### **ðŸ“… Production Calendar & Timeline Integration:**
- **Real ChannelCalendar.jsx**: Monthly view connected to production API
- **Real ChannelTimeline.jsx**: Full Gantt chart with dependencies
- **Seamless View Switching**: Chat/Calendar/Timeline buttons in headers
- **Multi-Channel Support**: View multiple channels simultaneously

### **ðŸ”„ GOOGLE SYNC SYSTEM (IN DEVELOPMENT - CRITICAL PRIORITY):**
- **Expert Developer Fixes Applied**: End-exclusive dates, no email spam, timezone handling
- **Smart Strategy Algorithm**: Auto-determines Calendar vs Tasks vs Both based on task attributes
- **De-duplication System**: sourceKey prevents duplicate events/tasks
- **Incremental Sync**: Calendar uses syncToken, Tasks uses updatedMin for efficiency
- **Per-Workspace Calendars**: Secondary calendars to avoid primary calendar spam
- **Field-Level Conflict Resolution**: Title/notes overwritable, completion status protected

## Architecture Decisions
- **Channel-Based Projects**: Each channel IS a project (simple, scalable)
- **Multi-Assignee Innovation**: Two modes for task completion tracking
- **Team-Based Collaboration**: Groups can be assigned and @mentioned
- **Professional Design**: Modern color system with channel color coding
- **Zero Learning Curve**: Familiar chat interface with powerful new views
- **Google Sync Integration**: Intelligent sync to Calendar (time-blocking) and Tasks (completion tracking)

## Database Schema (Current + Planned)
### **Current (Live):**
- âœ… `channel_tasks` table: Enhanced with multi-assignee support
- âœ… `workspace_teams` table: Team/group definitions
- âœ… `workspace_team_members` table: Team membership relationships
- âœ… **Views**: `channel_tasks_with_progress`, `user_task_assignments`
- âœ… **Functions**: `is_task_assignee()`, `get_task_completion_progress()`, `mark_task_complete_individual()`

### **Planned (Migration 023 - IMMEDIATE):**
- ðŸ”„ `channel_tasks` enhanced: google_task_id, google_calendar_event_id, sync_strategy, timezone
- ðŸ”„ `workspace_google_sync_config` table: Per-workspace sync configuration
- ðŸ”„ `user_google_sync_preferences` table: User OAuth tokens and preferences
- ðŸ”„ `google_sync_operations` table: Operation logging and debugging

## Key API Endpoints
### **Current (Multi-Assignee):**
- `GET /api/workspaces/:id/threads/:id/tasks` - Enhanced with multi-assignee data
- `POST /api/workspaces/:id/threads/:id/tasks` - Create with assignees/teams
- `POST /api/workspaces/:id/threads/:id/tasks/:id/complete` - Individual completion
- `GET /api/workspaces/:id/threads/:id/tasks/:id/progress` - Progress tracking
- `GET /api/workspaces/:id/teams` - Team management
- `POST /api/workspaces/:id/teams` - Create teams

### **Planned (Google Sync - IMMEDIATE PRIORITY):**
- `POST /api/workspaces/:ws/threads/:th/tasks/:taskId/sync/google` - Manual sync trigger
- `GET /api/workspaces/:ws/sync/google/status` - Sync health monitoring
- `GET /api/auth/google/authorize` - OAuth authorization flow
- `GET /api/auth/google/callback` - OAuth callback handling

## Testing Checklist (Production)
### **Current Revolutionary Features:**
1. âœ… **View Switching**: Click Chat/Calendar/Timeline buttons in channel headers
2. ðŸ”„ **Calendar View**: See real tasks from API in monthly calendar format
3. ðŸ”„ **Timeline View**: Gantt chart with task dependencies and progress bars
4. ðŸ”„ **Multi-Assignee**: Look for "2/7 done" style progress indicators
5. ðŸ”„ **Team Assignment**: Create teams and assign to tasks
6. ðŸ”„ **Individual Completion**: Each assignee marks done separately
7. ðŸ”„ **@Team Mentions**: Type @team-name in chat (future iteration)

### **Google Sync Testing (NEXT PHASE):**
8. ðŸ”„ **Google OAuth**: Authorize Google Calendar + Tasks access
9. ðŸ”„ **Smart Strategy**: Verify tasks sync to appropriate Google service
10. ðŸ”„ **No Email Spam**: Confirm no unintended email notifications
11. ðŸ”„ **De-duplication**: Prevent duplicate events using sourceKey
12. ðŸ”„ **Timezone Handling**: Proper timezone conversion in events
13. ðŸ”„ **Conflict Resolution**: Handle simultaneous edits gracefully

## File Locations (Production Ready + Planned)
### **Current:**
- **Database Schema**: `backend/migrations/` (BACK TO MIGRATION SYSTEM)
- **Database Setup**: `backend/setup-database.js` (uses migrations via run-migrations.js)
- **Migration Runner**: `backend/migrations/run-migrations.js` (core database setup)
- **Calendar**: `frontend/src/components/calendar/ChannelCalendar.jsx`
- **Timeline**: `frontend/src/components/timeline/ChannelTimeline.jsx` 
- **Multi-Channel**: `frontend/src/components/calendar/ChannelDropdown.jsx`
- **API**: `backend/routes/channel-tasks.js` (enhanced with multi-assignee)
- **Design System**: `frontend/tailwind.config.js` (professional color palette)

### **Google Sync Implementation (IMMEDIATE PRIORITY):**
- **Schema Enhancement**: Create new migration files in `backend/migrations/`
- **Core Logic**: `backend/sync/mappers.js` (strategy algorithm + data mapping)
- **Calendar Provider**: `backend/sync/google/CalendarProvider.js`
- **Tasks Provider**: `backend/sync/google/TasksProvider.js`
- **Main Service**: `backend/sync/SyncService.js`
- **Backoff Utility**: `backend/utils/backoff.js`
- **Routes**: `backend/routes/googleSync.js`, `backend/routes/googleAuth.js`
- **Frontend**: `frontend/src/components/sync/GoogleSyncButton.jsx`

## Deployment Process
1. **Develop Locally**: Make changes and test using `backend/setup-database.js` (runs migrations)
2. **Git Commit**: `git add . && git commit -m "description"`
3. **Deploy to Dev**: `./deploy-dev.sh patch "work completed description"`
4. **Test in Dev**: Validate features in development environment
5. **User Deploys to Production**: After successful dev testing, user will deploy to production
6. **Auto-Build**: DigitalOcean rebuilds app automatically on production deploy
7. **Migration Execution**: Migrations in `backend/migrations/` execute on startup

## Emergency Procedures
- **Rollback**: `git revert HEAD && git push origin main`
- **Check Logs**: DigitalOcean App Platform â†’ Runtime Logs
- **Database Access**: Use provided DigitalOcean database credentials
- **Migration Issues**: Check individual migration files in `backend/migrations/` for any syntax errors

## ðŸš¨ CRITICAL NEXT SESSION PRIORITIES

### **Phase 1: Database & Core Infrastructure (START HERE):**
1. **Create Google Sync Migration**: New migration file in `backend/migrations/026_google_sync_final.sql`
2. **Install Dependencies**: `npm install googleapis@^128.0.0 node-cache@^5.1.2`
3. **Create Mappers**: `backend/sync/mappers.js` with expert fixes (end-exclusive dates, timezone handling)

### **Phase 2: Google API Providers:**
4. **Calendar Provider**: `backend/sync/google/CalendarProvider.js` with syncToken support
5. **Tasks Provider**: `backend/sync/google/TasksProvider.js` with updatedMin polling
6. **Backoff Utility**: `backend/utils/backoff.js` for API rate limiting

### **Phase 3: Service Layer:**
7. **Sync Service**: `backend/sync/SyncService.js` main orchestration
8. **Routes**: `backend/routes/googleSync.js` and `backend/routes/googleAuth.js`

### **Success Metrics (Expert Developer Requirements):**
- **Sync Accuracy**: >95% successful operations
- **Performance**: <2 second sync completion  
- **No Email Spam**: Zero unintended notifications
- **De-duplication**: 100% prevention of duplicate events
- **Conflict Rate**: <2% of operations requiring manual resolution

**ðŸŽ¯ IMMEDIATE FOCUS**: Create migration 026 for Google sync tables - this is the foundation for the entire Google sync system with expert developer fixes applied.
